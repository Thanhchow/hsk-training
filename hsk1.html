<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi th·ª≠ HSK 1 - Simulation</title>
    <link rel="icon" type="image/png" href="favicon-32x32.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --primary: #2C3E50; --accent: #FF4757; --bg: #F0F2F5; --white: #fff; --success: #2ED573; }
        body { font-family: 'Montserrat', 'Noto Sans SC', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: #333; }

        /* HEADER */
        .header { background: var(--white); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 60px; z-index: 20; }
        .timer-box { background: var(--primary); color: white; padding: 8px 20px; border-radius: 50px; font-weight: bold; font-size: 1.1rem; }
        
        /* START SCREEN */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .start-card { max-width: 500px; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); background: white; border-top: 5px solid var(--accent); }
        .start-btn { background: var(--accent); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 30px; transition: transform 0.2s; }
        .start-btn:hover { transform: scale(1.05); }

        /* MAIN LAYOUT */
        .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        .question-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .question-card { background: white; width: 100%; max-width: 800px; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 80px; transition: all 0.3s; }
        
        /* EXAMPLE MODE STYLE */
        .question-card.example-mode { border: 2px solid #FFC107; background: #FFF9E6; }
        .example-tag { background: #FFC107; color: #333; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 0.8rem; margin-bottom: 10px; display: inline-block; }

        .section-badge { display: inline-block; background: #FFEBEE; color: var(--accent); padding: 5px 12px; border-radius: 20px; font-weight: 700; margin-bottom: 15px; font-size: 0.9rem; }
        .q-text { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: var(--primary); }
        .q-image-container img { max-height: 200px; border-radius: 8px; border: 2px solid #eee; margin: 10px 0; }

        /* AUDIO */
        .audio-control { background: #f8f9fa; padding: 12px 20px; border-radius: 50px; display: flex; align-items: center; gap: 10px; cursor: pointer; border: 1px solid #eee; margin-bottom: 20px; width: fit-content; transition: 0.2s; }
        .audio-control:hover { background: #eef2f5; transform: scale(1.02); }

        /* OPTIONS LAYOUT */
        .options-grid { display: grid; gap: 15px; margin-top: 20px; width: 100%; }
        
        /* TEXT OPTION */
        .option-btn { padding: 15px 20px; border: 2px solid #f0f0f0; border-radius: 12px; background: white; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .option-btn:hover { border-color: var(--primary); background: #f8fbff; }
        .option-btn.selected { border-color: var(--accent); background: #FFF0F0; font-weight: 700; }
        .option-key { width: 30px; height: 30px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .option-btn.selected .option-key { background: var(--accent); color: white; }

        /* IMAGE OPTION (GRID 3 C·ªòT) */
        .options-grid.image-mode { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .option-image-card { border: 2px solid #f0f0f0; border-radius: 12px; cursor: pointer; overflow: hidden; transition: 0.2s; position: relative; }
        .option-image-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .option-image-card.selected { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,71,87,0.2); }
        .option-image-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .img-key { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .option-image-card.selected .img-key { background: var(--accent); }

        /* SIDEBAR */
        .sidebar { width: 300px; background: white; border-left: 1px solid #eee; display: flex; flex-direction: column; z-index: 10; }
        .q-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 15px; }
        .q-dot { aspect-ratio: 1; border-radius: 8px; background: #f5f5f5; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
        .q-dot.active { border: 2px solid var(--accent); background: white; color: var(--accent); }
        .q-dot.answered { background: var(--primary); color: white; }
        
        /* FOOTER NAV */
        .nav-buttons { position: fixed; bottom: 0; left: 0; right: 300px; padding: 15px 30px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        .nav-btn { padding: 10px 30px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; }
        .submit-btn { width: 90%; margin: 20px auto; display: block; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 50px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .nav-buttons { right: 0; }
        }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="start-card">
            <h1 style="color:var(--primary); margin-bottom:10px;">HSK 1 - MOCK TEST</h1>
            <p style="color:#666; font-size:1.1rem;">M√¥ ph·ªèng ƒë·ªÅ thi th·∫≠t chu·∫©n qu·ªëc t·∫ø</p>
            <div style="text-align:left; margin: 30px 0; background:#f8f9fa; padding:20px; border-radius:10px;">
                <p>üìù <b>S·ªë c√¢u h·ªèi:</b> 40 c√¢u</p>
                <p>‚è± <b>Th·ªùi gian:</b> 40 ph√∫t</p>
                <p>üéß <b>K·ªπ nƒÉng:</b> Nghe hi·ªÉu & ƒê·ªçc hi·ªÉu</p>
                <p>üí° <b>L∆∞u √Ω:</b> C√°c c√¢u "V√≠ d·ª•" s·∫Ω kh√¥ng t√≠nh ƒëi·ªÉm.</p>
            </div>
            <button class="start-btn" onclick="startExam()">B·∫ÆT ƒê·∫¶U L√ÄM B√ÄI</button>
            <p style="margin-top:20px; font-size:0.9rem; cursor:pointer; color:#999;" onclick="window.location.href='index.html'">Quay l·∫°i trang ch·ªß</p>
        </div>
    </div>

    <div class="header">
        <div style="font-weight:700; cursor:pointer" onclick="if(confirm('Tho√°t b√†i thi?')) window.location.href='index.html'">‚¨Ö Tho√°t</div>
        <div class="timer-box">‚è± <span id="timer">40:00</span></div>
        <div style="font-weight:700">HSK 1</div>
    </div>

    <div class="main-container">
        <div class="question-area">
            <div class="question-card" id="q-card">
                <div id="example-tag" style="display:none;" class="example-tag">V√ç D·ª§ M·∫™U (EXAMPLE)</div>
                <div class="section-badge" id="section-badge">Ph·∫ßn thi</div>
                
                <div class="audio-control" id="audio-control" onclick="playAudio()">
                    <span style="font-size:1.5rem">üîä</span> <span id="audio-text">Nghe c√¢u h·ªèi</span>
                </div>

                <div id="question-content"></div>

                <div class="options-grid" id="options-container"></div>
            </div>

            <div class="nav-buttons">
                <button class="nav-btn" style="background:#eee" onclick="prevQuestion()">C√¢u tr∆∞·ªõc</button>
                <button class="nav-btn" style="background:var(--primary); color:white" onclick="nextQuestion()">C√¢u ti·∫øp theo</button>
            </div>
        </div>

        <div class="sidebar">
            <div style="padding:15px; border-bottom:1px solid #eee; font-weight:bold; text-align:center">DANH S√ÅCH C√ÇU H·ªéI</div>
            <div style="flex:1; overflow-y:auto; padding:10px;">
                <div style="font-size:0.8rem; color:#999; margin:10px 0 5px 10px;">LISTENING</div>
                <div class="q-grid" id="grid-listening"></div>
                <div style="font-size:0.8rem; color:#999; margin:20px 0 5px 10px;">READING</div>
                <div class="q-grid" id="grid-reading"></div>
            </div>
            <div style="padding:20px; border-top:1px solid #eee;">
                <button class="submit-btn" onclick="submitTest()">N·ªòP B√ÄI</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--primary)">K·∫æT QU·∫¢</h2>
            <div style="width:120px; height:120px; border-radius:50%; border:6px solid var(--accent); margin:20px auto; display:flex; justify-content:center; align-items:center; font-size:2.5rem; font-weight:800; color:var(--accent);">
                <span id="final-score">0</span>
            </div>
            <p id="pass-msg" style="font-weight:bold; font-size:1.1rem"></p>
            <button class="submit-btn" onclick="window.location.href='index.html'">V·ªÅ Trang Ch·ªß</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, doc, updateDoc, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgc-OYf_lq9bTu_lQv46XbYtnEp4SBynY",
            authDomain: "hsk-plus-web.firebaseapp.com",
            projectId: "hsk-plus-web",
            storageBucket: "hsk-plus-web.firebasestorage.app",
            messagingSenderId: "757004452643",
            appId: "1:757004452643:web:cbef488f9d7699ac034296",
            measurementId: "G-8XVEFW19DQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => currentUser = user);

        window.saveTestResult = async function(score, total) {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            try {
                const docSnap = await getDoc(userRef);
                const data = { testName: "HSK 1 Mock", score, total, date: new Date().toISOString(), pass: score >= 120 };
                if (!docSnap.exists()) await setDoc(userRef, { testHistory: [data] });
                else await updateDoc(userRef, { testHistory: arrayUnion(data) });
            } catch (e) { console.error(e); }
        }
    </script>

    <script>
        let examData = [];
        let currentIdx = 0;
        let userAnswers = []; // S·∫Ω kh·ªüi t·∫°o l·∫°i khi load data
        let timeLeft = 40 * 60;
        let timerInterval;

        // Ch·ªâ t·∫£i d·ªØ li·ªáu, ch∆∞a ch·∫°y ƒë·ªìng h·ªì
        fetch('exam_data.json')
            .then(res => res.json())
            .then(data => {
                examData = data;
                // L·ªçc ra c√°c c√¢u KH√îNG PH·∫¢I V√ç D·ª§ ƒë·ªÉ t·∫°o b·∫£ng tr·∫£ l·ªùi
                const realQuestionsCount = examData.filter(q => !q.isExample).length;
                // M·∫£ng c√¢u tr·∫£ l·ªùi ph·∫£i map theo ID th·ª±c t·∫ø, ·ªü ƒë√¢y d√πng simple map
                // L∆∞u √Ω: examData c√≥ c·∫£ v√≠ d·ª• xen k·∫Ω.
                userAnswers = new Array(examData.length).fill(null);
                console.log("Data loaded. Waiting for start.");
            })
            .catch(err => alert("L·ªói t·∫£i ƒë·ªÅ thi! (C·∫ßn ch·∫°y tr√™n Server)"));

        function startExam() {
            if (examData.length === 0) { alert("ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ƒë·ª£i..."); return; }
            document.getElementById('start-screen').style.display = 'none';
            renderSidebar();
            loadQuestion(0);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
                if (timeLeft <= 0) { clearInterval(timerInterval); submitTest(); }
            }, 1000);
        }

        function renderSidebar() {
            const listGrid = document.getElementById('grid-listening');
            const readGrid = document.getElementById('grid-reading');
            listGrid.innerHTML = ""; readGrid.innerHTML = "";

            examData.forEach((q, idx) => {
                // Kh√¥ng hi·ªÉn th·ªã c√¢u v√≠ d·ª• tr√™n sidebar
                if (q.isExample) return;

                const div = document.createElement('div');
                div.className = 'q-dot';
                div.innerText = q.id; // Hi·ªÉn th·ªã ID c√¢u h·ªèi th·ª±c t·∫ø
                div.id = `dot-${idx}`;
                div.onclick = () => loadQuestion(idx);
                
                if (q.type === 'listening') listGrid.appendChild(div);
                else readGrid.appendChild(div);
            });
        }

        function loadQuestion(idx) {
            currentIdx = idx;
            const q = examData[idx];
            
            // X·ª≠ l√Ω giao di·ªán V√≠ d·ª•
            const card = document.getElementById('q-card');
            const exTag = document.getElementById('example-tag');
            
            if (q.isExample) {
                card.classList.add('example-mode');
                exTag.style.display = 'inline-block';
            } else {
                card.classList.remove('example-mode');
                exTag.style.display = 'none';
                
                // Highlight sidebar (ch·ªâ highlight c√¢u th·∫≠t)
                document.querySelectorAll('.q-dot').forEach(d => d.classList.remove('active'));
                const dot = document.getElementById(`dot-${idx}`);
                if (dot) dot.classList.add('active');
            }

            document.getElementById('section-badge').innerText = q.section;
            document.getElementById('audio-control').style.display = q.type === 'listening' ? 'flex' : 'none';

            // Content
            let html = `<div class="q-text">${q.content}</div>`;
            if (q.image) html += `<div class="q-image-container"><img src="${q.image}"></div>`;
            document.getElementById('question-content').innerHTML = html;

            // Options
            const container = document.getElementById('options-container');
            container.innerHTML = "";
            const letters = ['A', 'B', 'C', 'D'];

            // Ki·ªÉm tra lo·∫°i hi·ªÉn th·ªã ƒë√°p √°n (Image Grid hay Text List)
            if (q.optionType === 'image') {
                container.className = "options-grid image-mode"; // Chuy·ªÉn sang Grid 3 c·ªôt
                q.options.forEach((optImg, i) => {
                    const div = document.createElement('div');
                    div.className = `option-image-card ${userAnswers[idx] === i ? 'selected' : ''}`;
                    div.innerHTML = `<img src="${optImg}"><div class="img-key">${letters[i]}</div>`;
                    div.onclick = () => selectAnswer(idx, i);
                    container.appendChild(div);
                });
            } else {
                container.className = "options-grid"; // Text List d·ªçc
                q.options.forEach((optText, i) => {
                    const div = document.createElement('div');
                    div.className = `option-btn ${userAnswers[idx] === i ? 'selected' : ''}`;
                    
                    // Logic hi·ªÉn th·ªã A/B/C hay t√≠ch/ch√©o
                    let key = letters[i];
                    if (q.options.length === 2) key = (i === 0) ? '‚úî' : '‚úò'; // ƒê√∫ng/Sai
                    
                    div.innerHTML = `<div class="option-key">${key}</div><div>${optText}</div>`;
                    div.onclick = () => selectAnswer(idx, i);
                    container.appendChild(div);
                });
            }
        }

        function selectAnswer(qIdx, ansIdx) {
            // N·∫øu l√† v√≠ d·ª• th√¨ kh√¥ng cho ch·ªçn (ho·∫∑c ch·ªçn ch∆°i th√¥i kh√¥ng l∆∞u)
            if (examData[qIdx].isExample) return;

            userAnswers[qIdx] = ansIdx;
            loadQuestion(qIdx); // Re-render
            const dot = document.getElementById(`dot-${qIdx}`);
            if(dot) dot.classList.add('answered');
        }

        function nextQuestion() { if (currentIdx < examData.length - 1) loadQuestion(currentIdx + 1); }
        function prevQuestion() { if (currentIdx > 0) loadQuestion(currentIdx - 1); }

        function playAudio() {
            const text = examData[currentIdx].audioText;
            if (!text) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN'; u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        function submitTest() {
            if(!confirm("N·ªôp b√†i ngay?")) return;
            clearInterval(timerInterval);
            
            let correctCount = 0;
            let realQuestions = 0;

            examData.forEach((q, idx) => {
                if (!q.isExample) {
                    realQuestions++;
                    if (userAnswers[idx] === q.correct) correctCount++;
                }
            });

            // T√≠nh ƒëi·ªÉm (Thang 200)
            const score = Math.round((correctCount / realQuestions) * 200);
            
            document.getElementById('resultModal').style.display = 'flex';
            document.getElementById('final-score').innerText = score;
            
            const msg = document.getElementById('pass-msg');
            if (score >= 120) {
                msg.innerText = "üéâ ƒê·∫¨U R·ªíI! (PASS)";
                msg.style.color = "var(--success)";
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            } else {
                msg.innerText = "C·∫¶N C·ªê G·∫ÆNG H∆†N (FAIL)";
                msg.style.color = "var(--accent)";
            }

            if(window.saveTestResult) window.saveTestResult(score, 200);
        }
    </script>
</body>
</html>