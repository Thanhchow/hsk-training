<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi th·ª≠ HSK 1 - HSK Plus</title>
    
    <link rel="icon" type="image/png" href="favicon-32x32.png">
    <meta name="theme-color" content="#ffffff">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2C3E50; --accent: #FF4757; --bg: #F0F2F5; --white: #fff; --success: #2ED573; --warning: #FFA502; }
        body { font-family: 'Montserrat', 'Noto Sans SC', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; color: #333; }

        /* HEADER */
        .header { background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .logo { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; cursor: pointer; color: var(--primary); }
        .logo:hover { color: var(--accent); }
        
        .timer-box { 
            background: var(--primary); color: white; padding: 8px 15px; border-radius: 50px; 
            font-variant-numeric: tabular-nums; font-weight: bold; font-size: 1rem; 
            box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); display: flex; align-items: center; gap: 5px;
        }
        
        /* LAYOUT */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* C·ªòT TR√ÅI: N·ªòI DUNG C√ÇU H·ªéI */
        .question-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; position: relative; }
        .question-card { background: white; width: 100%; max-width: 700px; border-radius: 15px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        
        .section-badge { display: inline-block; background: #FFEBEE; color: var(--accent); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; margin-bottom: 15px; }
        .q-text { font-size: 1.3rem; font-weight: 600; margin-bottom: 15px; line-height: 1.4; color: var(--primary); }
        
        /* H√åNH ·∫¢NH */
        .q-image-container { text-align: center; margin: 15px 0; }
        .q-image { max-width: 100%; height: auto; max-height: 250px; border-radius: 8px; border: 2px solid #eee; }

        /* AUDIO PLAYER */
        .audio-control { 
            background: #f8f9fa; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; 
            cursor: pointer; transition: 0.2s; border: 1px solid #eee; margin-bottom: 20px; width: fit-content;
        }
        .audio-control:hover { background: #eef2f5; border-color: #cbd5e0; }
        .audio-icon { font-size: 1.5rem; }
        .audio-label { font-size: 0.9rem; font-weight: 600; color: #555; }

        /* ƒê√ÅP √ÅN */
        .options-grid { display: grid; gap: 12px; margin-top: 20px; }
        .option-btn { 
            padding: 15px 20px; border: 2px solid #f0f0f0; border-radius: 10px; background: white; 
            cursor: pointer; text-align: left; transition: 0.2s; font-size: 1rem; display: flex; align-items: center; gap: 10px;
        }
        .option-btn:hover { border-color: var(--primary); background: #f8fbff; }
        .option-btn.selected { border-color: var(--accent); background: #FFF0F0; color: var(--accent); font-weight: 700; }
        .option-key { width: 25px; height: 25px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: #666; }
        .option-btn.selected .option-key { background: var(--accent); color: white; }

        /* C·ªòT PH·∫¢I: ƒêI·ªÄU H∆Ø·ªöNG */
        .sidebar { width: 280px; background: white; border-left: 1px solid #eee; display: flex; flex-direction: column; z-index: 5; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: 700; color: var(--primary); text-align: center; }
        
        .grid-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .q-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .q-dot { 
            aspect-ratio: 1; border-radius: 8px; background: #f5f5f5; color: #666; font-size: 0.85rem; font-weight: 600;
            display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .q-dot:hover { background: #e0e0e0; }
        .q-dot.active { border-color: var(--accent); color: var(--accent); background: #fff; box-shadow: 0 0 0 2px rgba(255, 71, 87, 0.2); }
        .q-dot.answered { background: var(--primary); color: white; }

        /* NAVIGATION BUTTONS */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 20px; max-width: 700px; width: 100%; }
        .nav-btn { padding: 10px 25px; border-radius: 50px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-prev { background: #eee; color: #555; }
        .btn-prev:hover { background: #ddd; }
        .btn-next { background: var(--primary); color: white; }
        .btn-next:hover { background: #1a252f; }

        .submit-area { padding: 20px; border-top: 1px solid #eee; }
        .submit-btn { width: 100%; background: var(--accent); color: white; padding: 12px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 71, 87, 0.4); }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; animation: slideUp 0.3s ease; }
        .score-display { font-size: 3rem; font-weight: 800; color: var(--accent); margin: 10px 0; }
        
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { display: none; position: fixed; top: 0; right: 0; height: 100%; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
            .sidebar.open { display: flex; }
            .header { font-size: 0.9rem; }
            .mobile-menu-btn { display: block; font-size: 1.5rem; cursor: pointer; }
        }
        @media (min-width: 769px) { .mobile-menu-btn { display: none; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo" onclick="window.location.href='index.html'">
            <span>‚¨Ö Quay l·∫°i</span>
        </div>
        <div class="timer-box">
            <span>‚è±</span> <span id="timer">40:00</span>
        </div>
        <div class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</div>
    </div>

    <div class="main-container">
        <div class="question-area">
            <div class="question-card">
                <div class="section-badge" id="section-badge">Ph·∫ßn 1</div>
                
                <div class="audio-control" id="audio-control" onclick="playAudio()">
                    <span class="audio-icon">üîä</span>
                    <div class="audio-label" id="audio-text">B·∫•m v√†o ƒë√¢y ƒë·ªÉ nghe</div>
                </div>

                <div id="question-content"></div>

                <div class="options-grid" id="options-container"></div>
            </div>

            <div class="nav-buttons">
                <button class="nav-btn btn-prev" onclick="prevQuestion()">C√¢u tr∆∞·ªõc</button>
                <button class="nav-btn btn-next" onclick="nextQuestion()">C√¢u ti·∫øp theo</button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                B·∫£ng C√¢u H·ªèi (40)
                <span style="float:right; cursor:pointer; font-size:1.2rem" class="mobile-menu-btn" onclick="toggleSidebar()">√ó</span>
            </div>
            <div class="grid-scroll">
                <div style="margin-bottom:10px; font-weight:bold; font-size:0.8rem; color:#999;">PH·∫¶N NGHE (1-20)</div>
                <div class="q-grid" id="grid-listening"></div>
                
                <div style="margin-top:20px; margin-bottom:10px; font-weight:bold; font-size:0.8rem; color:#999;">PH·∫¶N ƒê·ªåC (21-40)</div>
                <div class="q-grid" id="grid-reading"></div>
            </div>
            <div class="submit-area">
                <button class="submit-btn" onclick="submitTest()">N·ªòP B√ÄI</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="margin:0; color:var(--primary)">K·∫øt Qu·∫£ Thi</h2>
            <div style="font-size:0.9rem; color:#666; margin-top:5px">HSK 1 - Mock Test</div>
            
            <div class="score-display" id="final-score">0</div>
            <div style="font-weight:bold; color:#555">/ 200 ƒêi·ªÉm</div>
            
            <p id="pass-msg" style="font-weight:600; margin: 20px 0;"></p>
            
            <button class="submit-btn" onclick="window.location.href='index.html'">V·ªÅ trang ch·ªß</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, doc, updateDoc, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgc-OYf_lq9bTu_lQv46XbYtnEp4SBynY",
            authDomain: "hsk-plus-web.firebaseapp.com",
            projectId: "hsk-plus-web",
            storageBucket: "hsk-plus-web.firebasestorage.app",
            messagingSenderId: "757004452643",
            appId: "1:757004452643:web:cbef488f9d7699ac034296",
            measurementId: "G-8XVEFW19DQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) currentUser = user;
            else { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u k·∫øt qu·∫£!"); window.location.href = 'index.html'; }
        });

        window.saveTestResult = async function(score) {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const resultData = {
                testName: "HSK 1 Mock Test",
                score: score,
                total: 200,
                date: new Date().toISOString(),
                pass: score >= 120
            };
            try {
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) await setDoc(userRef, { testHistory: [resultData] });
                else await updateDoc(userRef, { testHistory: arrayUnion(resultData) });
            } catch (e) { console.error(e); }
        }
    </script>

    <script>
        // --- D·ªÆ LI·ªÜU ƒê·ªÄ THI 40 C√ÇU (CHU·∫®N C·∫§U TR√öC HSK 1) ---
        // L∆∞u √Ω: ·∫¢nh ƒëang d√πng Placeholder (·∫¢nh gi·ªØ ch·ªó). B·∫°n h√£y thay b·∫±ng link ·∫£nh th·∫≠t.
        
        const examData = [];

        // H√ÄM T·∫†O D·ªÆ LI·ªÜU GI·∫¢ (B·∫†N S·∫º S·ª¨A D·ªÆ LI·ªÜU ·ªû ƒê√ÇY)
        function generateData() {
            // --- PH·∫¶N 1: NGHE HI·ªÇU (20 C√ÇU) ---
            
            // Part 1 (1-5): ƒê√∫ng/Sai (H√¨nh vs √Çm thanh)
            for(let i=1; i<=5; i++) {
                examData.push({
                    id: i, type: "listening", section: "Nghe - Ph·∫ßn 1: ƒê√∫ng hay Sai?",
                    audioText: i % 2 === 0 ? "Fƒìijƒ´" : "Di√†nn«éo", // Ch·∫µn ƒë·ªçc M√°y bay, L·∫ª ƒë·ªçc M√°y t√≠nh
                    content: i % 2 === 0 ? "È£ûÊú∫ (Fƒìijƒ´)" : "ÁîµËÑë (Di√†nn«éo)",
                    image: `https://placehold.co/600x400?text=Hinh+Anh+Cau+So+${i}`, // Thay ·∫£nh th·∫≠t v√†o ƒë√¢y
                    options: ["ƒê√∫ng (True)", "Sai (False)"],
                    correct: 0 // M·∫∑c ƒë·ªãnh ƒë√°p √°n A (ƒê√∫ng)
                });
            }

            // Part 2 (6-10): Ch·ªçn h√¨nh ƒë√∫ng (Nghe c√¢u ch·ªçn h√¨nh)
            for(let i=6; i<=10; i++) {
                examData.push({
                    id: i, type: "listening", section: "Nghe - Ph·∫ßn 2: Ch·ªçn h√¨nh ƒë√∫ng",
                    audioText: "TƒÅ z√†i k√†n sh≈´ (C√¥ ·∫•y ƒëang ƒë·ªçc s√°ch)",
                    content: "Nghe v√† ch·ªçn b·ª©c tranh ph√π h·ª£p:",
                    // ·ªû ƒë√¢y option l√† Text m√¥ t·∫£ h√¨nh, th·ª±c t·∫ø b·∫°n c√≥ th·ªÉ ƒë·ªÉ th·∫ª <img src...> v√†o option
                    options: ["A. [H√¨nh ng∆∞·ªùi ƒëang ng·ªß]", "B. [H√¨nh ng∆∞·ªùi ƒë·ªçc s√°ch]", "C. [H√¨nh ng∆∞·ªùi ƒÉn c∆°m]"],
                    correct: 1
                });
            }

            // Part 3 (11-15): Ch·ªçn h√¨nh (H·ªôi tho·∫°i)
            for(let i=11; i<=15; i++) {
                examData.push({
                    id: i, type: "listening", section: "Nghe - Ph·∫ßn 3: H·ªôi tho·∫°i",
                    audioText: "N«ê h«éo! N«ê h«éo ma? - W«í hƒõn h«éo.",
                    content: "Ch·ªçn h√¨nh t∆∞∆°ng ·ª©ng v·ªõi ƒëo·∫°n h·ªôi tho·∫°i:",
                    options: ["A. [H√¨nh b·∫Øt tay]", "B. [H√¨nh t·∫°m bi·ªát]", "C. [H√¨nh nghe ƒëi·ªán tho·∫°i]"],
                    correct: 0
                });
            }

            // Part 4 (16-20): Ch·ªçn ƒë√°p √°n (Nghe c√¢u h·ªèi ch·ªçn c√¢u tr·∫£ l·ªùi)
            for(let i=16; i<=20; i++) {
                examData.push({
                    id: i, type: "listening", section: "Nghe - Ph·∫ßn 4: Tr·∫£ l·ªùi c√¢u h·ªèi",
                    audioText: "Jƒ´ntiƒÅn sh√¨ j«ê yu√® j«ê h√†o?", // H√¥m nay l√† ng√†y m·∫•y th√°ng m·∫•y?
                    content: "Ch·ªçn c√¢u tr·∫£ l·ªùi ƒë√∫ng:",
                    options: ["A. Xƒ´ngqƒ´ sƒÅn", "B. SƒÅn di«én", "C. BƒÅ yu√® w«î h√†o"], // C l√† ng√†y th√°ng
                    correct: 2
                });
            }

            // --- PH·∫¶N 2: ƒê·ªåC HI·ªÇU (20 C√ÇU) ---

            // Part 1 (21-25): ƒê√∫ng/Sai (H√¨nh vs Ch·ªØ)
            for(let i=21; i<=25; i++) {
                examData.push({
                    id: i, type: "reading", section: "ƒê·ªçc - Ph·∫ßn 1: ƒê√∫ng hay Sai?",
                    content: "MƒÅma (M·∫π)",
                    image: `https://placehold.co/600x400?text=Anh+Nguoi+Me`,
                    options: ["ƒê√∫ng", "Sai"],
                    correct: 0
                });
            }

            // Part 2 (26-30): N·ªëi tranh
            for(let i=26; i<=30; i++) {
                examData.push({
                    id: i, type: "reading", section: "ƒê·ªçc - Ph·∫ßn 2: Ch·ªçn h√¨nh",
                    content: "W«í x«êhuan chƒ´ p√≠nggu«í (T√¥i th√≠ch ƒÉn t√°o).",
                    options: ["A. [H√¨nh qu·∫£ t√°o]", "B. [H√¨nh qu·∫£ chu·ªëi]", "C. [H√¨nh d∆∞a h·∫•u]"],
                    correct: 0
                });
            }

            // Part 3 (31-35): N·ªëi c√¢u h·ªèi - tr·∫£ l·ªùi (Logic)
            for(let i=31; i<=35; i++) {
                examData.push({
                    id: i, type: "reading", section: "ƒê·ªçc - Ph·∫ßn 3: Ch·ªçn c√¢u tr·∫£ l·ªùi",
                    content: "N«ê ji√†o sh√©nme m√≠ngzi? (B·∫°n t√™n l√† g√¨?)",
                    options: ["A. W«í sh√¨ xu√©shƒìng", "B. W«í ji√†o L«ê Yu√®", "C. Xi√®xie"],
                    correct: 1
                });
            }

            // Part 4 (36-40): ƒêi·ªÅn t·ª´
            for(let i=36; i<=40; i++) {
                examData.push({
                    id: i, type: "reading", section: "ƒê·ªçc - Ph·∫ßn 4: ƒêi·ªÅn t·ª´",
                    content: "B√†ba ___ hƒì ch√°. (B·ªë ___ u·ªëng tr√†)",
                    options: ["A. x«êhuan (th√≠ch)", "B. sh√¨ (l√†)", "C. z√†i (·ªü)"],
                    correct: 0
                });
            }
        }
        generateData(); // Kh·ªüi t·∫°o 40 c√¢u

        // --- CORE LOGIC ---
        let currentIdx = 0;
        let userAnswers = new Array(40).fill(null);
        let timeLeft = 40 * 60; // 40 ph√∫t
        let timerInterval;

        function init() {
            renderSidebar();
            loadQuestion(0);
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
                if (timeLeft <= 0) { clearInterval(timerInterval); alert("H·∫øt gi·ªù!"); submitTest(); }
            }, 1000);
        }

        function renderSidebar() {
            const listGrid = document.getElementById('grid-listening');
            const readGrid = document.getElementById('grid-reading');
            
            examData.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = `q-dot`;
                div.innerText = idx + 1;
                div.id = `dot-${idx}`;
                div.onclick = () => { loadQuestion(idx); if(window.innerWidth<=768) toggleSidebar(); };
                
                if (idx < 20) listGrid.appendChild(div);
                else readGrid.appendChild(div);
            });
        }

        function loadQuestion(idx) {
            currentIdx = idx;
            const q = examData[idx];
            
            // C·∫≠p nh·∫≠t UI
            document.getElementById('section-badge').innerText = q.section;
            document.getElementById('audio-control').style.display = q.type === 'listening' ? 'flex' : 'none';
            
            // Highlight sidebar
            document.querySelectorAll('.q-dot').forEach(d => d.classList.remove('active'));
            document.getElementById(`dot-${idx}`).classList.add('active');

            // Render N·ªôi dung
            let contentHtml = `<div class="q-text">${q.content}</div>`;
            if (q.image) contentHtml += `<div class="q-image-container"><img src="${q.image}" class="q-image" alt="Question Image"></div>`;
            document.getElementById('question-content').innerHTML = contentHtml;

            // Render ƒê√°p √°n
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = "";
            const letters = ['A', 'B', 'C', 'D'];
            
            q.options.forEach((opt, optIdx) => {
                const btn = document.createElement('div');
                btn.className = `option-btn ${userAnswers[idx] === optIdx ? 'selected' : ''}`;
                // N·∫øu option l√† ƒê√∫ng/Sai th√¨ kh√¥ng c·∫ßn A,B,C
                const key = (q.options.length === 2) ? (optIdx === 0 ? '‚úî' : '‚úò') : letters[optIdx];
                
                btn.innerHTML = `<div class="option-key">${key}</div> <div>${opt}</div>`;
                btn.onclick = () => selectAnswer(idx, optIdx);
                optsContainer.appendChild(btn);
            });
        }

        function selectAnswer(qIdx, ansIdx) {
            userAnswers[qIdx] = ansIdx;
            loadQuestion(qIdx); // Re-render ƒë·ªÉ hi·ªán m√†u xanh
            document.getElementById(`dot-${qIdx}`).classList.add('answered');
        }

        function nextQuestion() { if (currentIdx < 39) loadQuestion(currentIdx + 1); }
        function prevQuestion() { if (currentIdx > 0) loadQuestion(currentIdx - 1); }

        function playAudio() {
            const text = examData[currentIdx].audioText;
            if (!text) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN'; u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        function submitTest() {
            if(!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?")) return;
            clearInterval(timerInterval);
            
            let score = 0;
            // M·ªói c√¢u 5 ƒëi·ªÉm (T·ªïng 200)
            examData.forEach((q, idx) => {
                if (userAnswers[idx] === q.correct) score += 5;
            });

            document.getElementById('resultModal').style.display = 'flex';
            document.getElementById('final-score').innerText = score;
            
            const msg = document.getElementById('pass-msg');
            if (score >= 120) {
                msg.innerText = "üéâ CH√öC M·ª™NG! B·∫†N ƒê√É ƒê·∫¨U HSK 1";
                msg.style.color = "var(--success)";
                triggerConfetti();
            } else {
                msg.innerText = "Chia bu·ªìn! B·∫°n c·∫ßn √¥n t·∫≠p th√™m (C·∫ßn 120ƒë).";
                msg.style.color = "var(--warning)";
            }

            if (window.saveTestResult) window.saveTestResult(score);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function triggerConfetti() {
            const script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
            script.onload = () => confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            document.body.appendChild(script);
        }

        init();
    </script>
</body>
</html>