<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi th·ª≠ HSK 1 - HSK Plus</title>
    
    <link rel="icon" type="image/png" href="favicon-32x32.png">
    <meta name="theme-color" content="#ffffff">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2C3E50; --accent: #FF4757; --bg: #F0F2F5; --white: #fff; --success: #2ED573; }
        body { font-family: 'Montserrat', 'Noto Sans SC', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* HEADER */
        .header { background: var(--primary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .timer-box { background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 5px; font-variant-numeric: tabular-nums; font-weight: bold; font-size: 1.1rem; }
        
        /* LAYOUT */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* C·ªòT TR√ÅI: C√ÇU H·ªéI */
        .question-area { flex: 7; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .question-card { background: white; width: 100%; max-width: 800px; border-radius: 10px; padding: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .section-title { color: var(--accent); font-weight: bold; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        /* AUDIO PLAYER GI·∫¢ L·∫¨P */
        .audio-player { background: #f1f3f4; padding: 15px; border-radius: 50px; display: flex; align-items: center; gap: 10px; width: fit-content; margin-bottom: 20px; cursor: pointer; transition: 0.2s; }
        .audio-player:hover { background: #e0e0e0; }
        
        /* CONTENT */
        .q-content { font-size: 1.2rem; margin-bottom: 20px; }
        .q-image { max-width: 200px; max-height: 200px; border-radius: 8px; margin: 10px 0; border: 1px solid #eee; }
        
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; width: 100%; }
        .option-btn { padding: 15px; border: 2px solid #eee; border-radius: 8px; background: white; cursor: pointer; text-align: left; transition: 0.2s; font-size: 1rem; }
        .option-btn:hover { border-color: var(--primary); background: #f9f9f9; }
        .option-btn.selected { border-color: var(--accent); background: #FFF0F0; color: var(--accent); font-weight: bold; }

        /* C·ªòT PH·∫¢I: NAVIGATION */
        .sidebar { flex: 3; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; max-width: 300px; }
        .nav-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; }
        .question-grid { padding: 15px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; overflow-y: auto; flex: 1; }
        .q-dot { width: 35px; height: 35px; border-radius: 5px; border: 1px solid #ccc; display: flex; justify-content: center; align-items: center; cursor: pointer; font-size: 0.9rem; }
        .q-dot.active { border-color: var(--primary); background: #eee; }
        .q-dot.answered { background: var(--primary); color: white; border-color: var(--primary); }
        .q-dot.flagged { border-color: orange; color: orange; }

        .sidebar-footer { padding: 20px; border-top: 1px solid #eee; text-align: center; }
        .submit-btn { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; transition: 0.2s; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3); }

        /* NAVIGATION BUTTONS */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; width: 100%; max-width: 800px; }
        .nav-btn { background: white; border: 1px solid #ccc; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        
        /* MODAL K·∫æT QU·∫¢ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; width: 90%; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 5px solid var(--accent); margin: 0 auto 20px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; color: var(--accent); }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { display: none; /* ·∫®n sidebar tr√™n mobile cho g·ªçn, c√≥ th·ªÉ l√†m n√∫t toggle sau */ }
            .header { font-size: 0.9rem; }
            .timer-box { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">
            <span style="cursor:pointer" onclick="window.location.href='index.html'">‚¨Ö Quay l·∫°i</span>
            <span> | HSK 1 Mock Test</span>
        </div>
        <div class="timer-box">‚è≥ <span id="timer">40:00</span></div>
    </div>

    <div class="main-container">
        <div class="question-area">
            <div class="question-card">
                <div class="section-title" id="section-title">Ph·∫ßn Nghe - Ph·∫ßn 1</div>
                
                <div class="audio-player" id="audio-control" onclick="playAudio()">
                    <span>üîä</span> <span id="audio-text">B·∫•m ƒë·ªÉ nghe c√¢u h·ªèi</span>
                </div>

                <div id="question-content">
                    </div>

                <div class="options-grid" id="options-container">
                    </div>
            </div>

            <div class="nav-buttons">
                <button class="nav-btn" onclick="prevQuestion()">Previous</button>
                <button class="nav-btn" onclick="nextQuestion()" style="background:var(--primary); color:white; border:none;">Next</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="nav-header">Danh s√°ch c√¢u h·ªèi</div>
            <div class="question-grid" id="question-grid">
                </div>
            <div class="sidebar-footer">
                <button class="submit-btn" onclick="submitTest()">N·ªòP B√ÄI</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2>K·∫øt Qu·∫£ Thi HSK 1</h2>
            <div class="score-circle" id="final-score">0</div>
            <p id="pass-fail-text">ƒêang t√≠nh...</p>
            <p style="color:#666; font-size:0.9rem;">K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªì s∆°.</p>
            <button class="submit-btn" onclick="window.location.href='index.html'">V·ªÅ trang ch·ªß</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, doc, updateDoc, arrayUnion, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // --- C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N (D√°n y h·ªát b√™n index.html) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBgc-OYf_lq9bTu_lQv46XbYtnEp4SBynY",
            authDomain: "hsk-plus-web.firebaseapp.com",
            projectId: "hsk-plus-web",
            storageBucket: "hsk-plus-web.firebasestorage.app",
            messagingSenderId: "757004452643",
            appId: "1:757004452643:web:cbef488f9d7699ac034296",
            measurementId: "G-8XVEFW19DQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l√†m b√†i thi!");
                window.location.href = 'index.html';
            }
        });

        // H√†m l∆∞u k·∫øt qu·∫£ thi
        window.saveTestResult = async function(score, total) {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            
            // T·∫°o object k·∫øt qu·∫£
            const resultData = {
                testName: "HSK 1 Mock Test",
                score: score,
                total: total,
                date: new Date().toISOString(),
                pass: score >= (total * 0.6) // ƒê·∫≠u n·∫øu tr√™n 60%
            };

            try {
                // Ki·ªÉm tra xem user doc c√≥ t·ªìn t·∫°i ch∆∞a
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) {
                    await setDoc(userRef, { testHistory: [resultData] });
                } else {
                    await updateDoc(userRef, {
                        testHistory: arrayUnion(resultData)
                    });
                }
                console.log("ƒê√£ l∆∞u k·∫øt qu·∫£ thi!");
            } catch (e) {
                console.error("L·ªói l∆∞u k·∫øt qu·∫£:", e);
            }
        }
    </script>

    <script>
        // --- D·ªÆ LI·ªÜU ƒê·ªÄ THI M·∫™U (B·∫†N C√ì TH·ªÇ TH√äM SAU) ---
        // Ph·∫ßn Nghe: D√πng text-to-speech c·ªßa Google Chrome
        const examData = [
            // PART 1: NGHE - ƒê√öNG SAI (5 c√¢u)
            {
                id: 1, type: "listening", section: "Nghe - Ph·∫ßn 1: ƒê√∫ng/Sai",
                audioText: "MƒÅma", // Audio ƒë·ªçc
                content: "Â¶àÂ¶à (M·∫π)", // H√¨nh ·∫£nh/Ch·ªØ hi·ªÉn th·ªã
                image: "https://img.freepik.com/free-vector/mother-hugging-her-daughter-illustration_114360-17215.jpg?w=200", // Link ·∫£nh
                options: ["ƒê√∫ng (True)", "Sai (False)"],
                correct: 0
            },
            {
                id: 2, type: "listening", section: "Nghe - Ph·∫ßn 1: ƒê√∫ng/Sai",
                audioText: "Hƒì shu«ê",
                content: "ÂêÉÈ•≠ (ƒÇn c∆°m)", 
                image: "https://img.freepik.com/free-vector/boy-drinking-water_1308-33316.jpg?w=200",
                options: ["ƒê√∫ng (True)", "Sai (False)"],
                correct: 1 // Sai v√¨ audio l√† u·ªëng n∆∞·ªõc
            },
            // PART 2: NGHE - CH·ªåN ·∫¢NH (3 c√¢u demo)
            {
                id: 3, type: "listening", section: "Nghe - Ph·∫ßn 2: Ch·ªçn h√¨nh",
                audioText: "TƒÅ z√†i k√†n sh≈´", // C√¥ ·∫•y ƒëang ƒë·ªçc s√°ch
                content: "Nghe c√¢u v√† ch·ªçn h√¨nh ƒë√∫ng:",
                options: ["A. [H√¨nh ng∆∞·ªùi ng·ªß]", "B. [H√¨nh ng∆∞·ªùi ƒë·ªçc s√°ch]", "C. [H√¨nh ng∆∞·ªùi ƒÉn]"],
                correct: 1
            },
            // PART 3: ƒê·ªåC HI·ªÇU (Demo)
            {
                id: 4, type: "reading", section: "ƒê·ªçc - Ph·∫ßn 1: N·ªëi t·ª´",
                content: "Ch·ªçn nghƒ©a ƒë√∫ng c·ªßa t·ª´: È£ûÊú∫ (Fƒìijƒ´)",
                options: ["A. Xe ƒë·∫°p", "B. M√°y bay", "C. T√†u h·ªèa"],
                correct: 1
            },
            {
                id: 5, type: "reading", section: "ƒê·ªçc - Ph·∫ßn 2: ƒêi·ªÅn t·ª´",
                content: "W«í ___ xu√©xiao. (T√¥i ƒëi tr∆∞·ªùng h·ªçc)",
                options: ["A. q√π (Âéª)", "B. z√†i (Âú®)", "C. sh√¨ (ÊòØ)"],
                correct: 0
            }
            // ... B·∫°n c√≥ th·ªÉ th√™m ƒë·ªß 40 c√¢u ·ªü ƒë√¢y ...
        ];

        // --- LOGIC B√ÄI THI ---
        let currentIdx = 0;
        let userAnswers = new Array(examData.length).fill(null);
        let timeLeft = 40 * 60; // 40 ph√∫t t√≠nh b·∫±ng gi√¢y
        let timerInterval;

        function init() {
            renderSidebar();
            loadQuestion(0);
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("H·∫øt gi·ªù! H·ªá th·ªëng s·∫Ω t·ª± n·ªôp b√†i.");
                    submitTest();
                }
            }, 1000);
        }

        function renderSidebar() {
            const grid = document.getElementById('question-grid');
            grid.innerHTML = "";
            examData.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = `q-dot ${idx === currentIdx ? 'active' : ''}`;
                div.innerText = idx + 1;
                div.onclick = () => loadQuestion(idx);
                div.id = `dot-${idx}`;
                grid.appendChild(div);
            });
        }

        function loadQuestion(idx) {
            currentIdx = idx;
            const q = examData[idx];
            
            // Update UI
            document.getElementById('section-title').innerText = q.section;
            document.getElementById('audio-control').style.display = q.type === 'listening' ? 'flex' : 'none';
            document.getElementById('audio-text').innerText = q.type === 'listening' ? "B·∫•m ƒë·ªÉ nghe" : "";
            
            // Update Sidebar Active state
            document.querySelectorAll('.q-dot').forEach(d => d.classList.remove('active'));
            document.getElementById(`dot-${idx}`).classList.add('active');

            // Render Content
            let html = `<div class="q-content">${q.content}</div>`;
            if (q.image) {
                html += `<img src="${q.image}" class="q-image" alt="Question Image">`;
            }
            document.getElementById('question-content').innerHTML = html;

            // Render Options
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = "";
            q.options.forEach((opt, optIdx) => {
                const btn = document.createElement('div');
                btn.className = `option-btn ${userAnswers[idx] === optIdx ? 'selected' : ''}`;
                btn.innerText = opt;
                btn.onclick = () => selectAnswer(idx, optIdx);
                optsContainer.appendChild(btn);
            });
        }

        function selectAnswer(qIdx, ansIdx) {
            userAnswers[qIdx] = ansIdx;
            // Update UI t·∫°i ch·ªó
            loadQuestion(qIdx);
            // Update Sidebar ƒë√£ l√†m
            document.getElementById(`dot-${qIdx}`).classList.add('answered');
        }

        function nextQuestion() {
            if (currentIdx < examData.length - 1) loadQuestion(currentIdx + 1);
        }

        function prevQuestion() {
            if (currentIdx > 0) loadQuestion(currentIdx - 1);
        }

        // --- AUDIO GI·∫¢ L·∫¨P (TEXT TO SPEECH) ---
        function playAudio() {
            const text = examData[currentIdx].audioText;
            if (!text) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-CN';
            u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        function submitTest() {
            clearInterval(timerInterval);
            
            // T√≠nh ƒëi·ªÉm
            let score = 0;
            let correctCount = 0;
            // Gi·∫£ s·ª≠ m·ªói c√¢u 5 ƒëi·ªÉm (T·ªïng 200 ƒëi·ªÉm cho 40 c√¢u)
            // ·ªû ƒë√¢y demo 5 c√¢u -> m·ªói c√¢u 40 ƒëi·ªÉm cho d·ªÖ h√¨nh dung
            const pointsPerQ = 200 / examData.length; 

            examData.forEach((q, idx) => {
                if (userAnswers[idx] === q.correct) {
                    correctCount++;
                }
            });

            score = Math.round(correctCount * pointsPerQ);

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById('resultModal').style.display = 'flex';
            document.getElementById('final-score').innerText = score;
            
            const pass = score >= 120; // HSK pass l√† 120/200
            const msg = document.getElementById('pass-fail-text');
            if (pass) {
                msg.innerText = "CH√öC M·ª™NG! B·∫†N ƒê√É ƒê·∫¨U HSK 1 üéâ";
                msg.style.color = "green";
                triggerConfetti();
            } else {
                msg.innerText = "Chia bu·ªìn! B·∫°n c·∫ßn √¥n th√™m (C·∫ßn > 120 ƒëi·ªÉm).";
                msg.style.color = "red";
            }

            // L∆∞u v√†o Firebase
            if (window.saveTestResult) {
                window.saveTestResult(score, 200);
            }
        }

        function triggerConfetti() {
            // Hi·ªáu ·ª©ng ph√°o hoa gi·ªëng index.html
            const confettiScript = document.createElement('script');
            confettiScript.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js";
            confettiScript.onload = () => {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            };
            document.body.appendChild(confettiScript);
        }

        // Kh·ªüi ch·∫°y
        init();
    </script>
</body>
</html>